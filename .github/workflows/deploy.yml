name: Deploy SafeWorld to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/upload-artifact@v4

      - name: Create config.js with API key
        run: |
          cat > config.js << 'EOF'
          // Configuration for SafeWorld Crime Map
          // Auto-generated for GitHub Pages deployment
          
          const CONFIG = {
            GOOGLE_MAPS_API_KEY: '${{ secrets.GOOGLE_MAPS_API_KEY }}'
          };
          
          // Function to load Google Maps script dynamically
          function loadGoogleMapsScript() {
            console.log('Loading Google Maps script...');
            
            return new Promise((resolve, reject) => {
              if (window.google && window.google.maps) {
                console.log('Google Maps already loaded');
                resolve();
                return;
              }
          
              const script = document.createElement('script');
              script.async = true;
              script.defer = true;
              script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=geometry`;
              
              script.onload = () => {
                console.log('Google Maps script loaded successfully');
                resolve();
              };
              
              script.onerror = (error) => {
                console.error('Failed to load Google Maps script:', error);
                reject(error);
              };
          
              document.head.appendChild(script);
            });
          }
          
          // Make sure initMap is available globally
          window.initMap = function() {
            console.log('initMap called - Google Maps API ready');
            if (typeof startApp === 'function') {
              startApp();
            }
          };
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3
